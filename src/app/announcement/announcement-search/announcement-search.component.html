<ocx-portal-page
  *ngIf="metaData$ | async as metaData"
  permission="ANNOUNCEMENT#SEARCH"
  helpArticleId="PAGE_ANNOUNCEMENT_SEARCH"
>
  <!-- declare slot to get data from product store -->
  <ocx-slot
    *ngIf="pdIsComponentDefined$ | async"
    [name]="pdSlotName"
    [inputs]="{ dataType: 'products', logEnabled: false, logPrefix: 'announcement' }"
    [outputs]="{ products: pdSlotEmitter }"
  >
  </ocx-slot>
  <!-- declare slot to get data from workspace -->
  <ocx-slot
    *ngIf="wdIsComponentDefined$ | async"
    [name]="wdSlotName"
    [inputs]="{ dataType: 'workspaces', logEnabled: false, logPrefix: 'announcement' }"
    [outputs]="{ workspaces: wdSlotEmitter }"
  >
  </ocx-slot>
  <app-announcement-criteria
    [actions]="(actions$ | async) ?? []"
    [usedProducts]="metaData.usedProducts ?? []"
    [usedWorkspaces]="metaData.usedWorkspaces ?? []"
    (searchEmitter)="onSearch($event)"
    (resetSearchEmitter)="onCriteriaReset()"
  ></app-announcement-criteria>

  <ocx-page-content>
    <p-message
      *ngIf="loadingMetaData"
      id="am_search_message_loading"
      severity="info"
      styleClass="m-3 p-2"
      [text]="'ACTIONS.LOADING' | translate"
    ></p-message>
    <p-message
      *ngIf="exceptionKey"
      id="am_search_message_error"
      severity="error"
      styleClass="m-3 p-2"
      [text]="exceptionKey | translate"
    ></p-message>

    <ng-container *ngIf="data$ | async as data">
      <p-message
        *ngIf="searching"
        id="am_search_message_searching"
        severity="info"
        styleClass="m-3 p-2"
        [text]="'ACTIONS.SEARCH.IN_PROGRESS' | translate"
      ></p-message>
      <p-table
        *ngIf="!(searching || exceptionKey)"
        #dataTable
        id="am_search_table"
        styleClass="mx-3 mb-2"
        [value]="data"
        [columns]="filteredColumns"
        dataKey="id"
        [globalFilterFields]="['title', 'workspaceName', 'productName']"
        [reorderableColumns]="false"
        [scrollable]="true"
        scrollHeight="590px"
        [rows]="10"
        [rowsPerPageOptions]="[10, 30, 100]"
        [paginator]="true"
        [alwaysShowPaginator]="true"
        paginatorPosition="bottom"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="{first} - {last} {{ 'ACTIONS.SEARCH.OF' | translate }} {totalRecords}"
      >
        <ng-template pTemplate="caption">
          <ocx-data-view-controls
            [supportedViews]="['table']"
            [enableFiltering]="true"
            [enableSorting]="false"
            [columnDefinitions]="columns"
            (columnsChange)="onColumnsChange($event)"
            (filterChange)="onFilterChange($event, dataTable)"
            [translations]="dataViewControlsTranslations"
          ></ocx-data-view-controls>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td id="am_search_table_emptymessage" colspan="16">{{ 'ACTIONS.SEARCH.NO_DATA' | translate }}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="header" let-columns>
          <tr>
            <th pFrozenColumn id="am_search_table_header_actions" class="border-right-1 text-center white-space-nowrap">
              {{ 'ACTIONS.LABEL' | translate }}
            </th>
            <th
              *ngFor="let col of columns"
              [id]="'am_search_table_header_col_' + col.field"
              [class]="col.css + ' white-space-nowrap'"
              [pSortableColumn]="col.field"
              [attr.aria-label]="'ANNOUNCEMENT.TOOLTIPS.' + col.header | translate"
              [pTooltip]="'ANNOUNCEMENT.TOOLTIPS.' + col.header | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <span>{{ col.translationPrefix + '.' + col.header | translate }}</span>
              <p-sortIcon [field]="col.field"></p-sortIcon>
              <p-columnFilter *ngIf="col.hasFilter" type="text" [field]="col.field" display="menu"></p-columnFilter>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-i="rowIndex" let-rowData let-columns="columns">
          <tr [pSelectableRow]="data">
            <!-- actions -->
            <td pFrozenColumn class="py-0 align-items-center border-right-1 text-center white-space-nowrap">
              <ng-container *ocxIfNotPermission="'ANNOUNCEMENT#EDIT'">
                <p-button
                  *ocxIfPermission="'ANNOUNCEMENT#VIEW'"
                  [id]="'am_search_table_row_' + i + '_action_view'"
                  type="button"
                  pRipple
                  [text]="true"
                  [plain]="true"
                  [rounded]="true"
                  [icon]="'pi pi-eye'"
                  (onClick)="onDetail('VIEW', rowData, $event)"
                  (keydown.enter)="onDetail('VIEW', rowData, $event)"
                  (keydown.space)="onDetail('VIEW', rowData, $event)"
                  [attr.aria-label]="'ACTIONS.VIEW.LABEL' | translate"
                  [pTooltip]="'ACTIONS.VIEW.LABEL' | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                />
              </ng-container>
              <p-button
                *ocxIfPermission="'ANNOUNCEMENT#EDIT'"
                [id]="'am_search_table_row_' + i + '_action_edit'"
                type="button"
                pRipple
                [text]="true"
                [plain]="true"
                [rounded]="true"
                [icon]="'pi pi-pencil'"
                (onClick)="onDetail('EDIT', rowData, $event)"
                (keydown.enter)="onDetail('EDIT', rowData, $event)"
                (keydown.space)="onDetail('EDIT', rowData, $event)"
                [attr.aria-label]="'ACTIONS.EDIT.LABEL' | translate"
                [pTooltip]="'ACTIONS.EDIT.LABEL' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              />
              <p-button
                *ocxIfPermission="'ANNOUNCEMENT#EDIT'"
                [id]="'am_search_table_row_' + i + '_action_copy'"
                type="button"
                pRipple
                [text]="true"
                [plain]="true"
                [rounded]="true"
                [icon]="'pi pi-copy'"
                (click)="onDetail('COPY', rowData, $event)"
                (keydown.enter)="onDetail('COPY', rowData, $event)"
                (keydown.space)="onDetail('COPY', rowData, $event)"
                [attr.aria-label]="'ACTIONS.COPY.LABEL' | translate"
                [pTooltip]="'ACTIONS.COPY.LABEL' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              />
              <p-button
                *ocxIfPermission="'ANNOUNCEMENT#DELETE'"
                [id]="'am_search_table_row_' + i + '_action_delete'"
                type="button"
                pRipple
                [text]="true"
                [plain]="true"
                [rounded]="true"
                [icon]="'pi pi-trash'"
                severity="danger"
                (click)="onDelete($event, rowData)"
                (keydown.enter)="onDelete($event, rowData)"
                (keydown.space)="onDelete($event, rowData)"
                [attr.aria-label]="'ACTIONS.DELETE.LABEL' | translate"
                [pTooltip]="'ACTIONS.DELETE.LABEL' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              />
            </td>
            <td *ngFor="let col of columns" [id]="'am_search_table_row_' + i + '_' + col.field" [class]="col.css">
              @switch (col.field) {
                @case ('type') {
                  <span
                    class="pi text-xl"
                    [class.pi-info-circle]="rowData[col.field] === 'INFO'"
                    [class.pi-calendar]="rowData[col.field] === 'EVENT'"
                    [class.pi-wrench]="rowData[col.field] === 'SYSTEM_MAINTENANCE'"
                    [attr.aria-label]="'ENUMS.ANNOUNCEMENT_TYPE.' + rowData[col.field] | translate"
                    [pTooltip]="'ENUMS.ANNOUNCEMENT_TYPE.' + rowData[col.field] | translate"
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  ></span>
                }
                @case ('status') {
                  <span
                    class="pi"
                    [class.pi-circle-on]="rowData[col.field] === 'ACTIVE'"
                    [class.pi-circle-off]="rowData[col.field] === 'INACTIVE'"
                    [class.pi-circle-off]="rowData[col.field] === 'INACTIVE'"
                    [class.text-red-600]="rowData['priority'] === 'IMPORTANT'"
                    [class.text-yellow-600]="rowData['priority'] === 'NORMAL'"
                    [class.text-blue-600]="rowData['priority'] === 'LOW'"
                    [attr.aria-label]="'ENUMS.ANNOUNCEMENT_STATUS.' + rowData[col.field] | translate"
                    [pTooltip]="
                      ('ENUMS.ANNOUNCEMENT_STATUS.' + rowData[col.field] | translate) +
                      ' - ' +
                      ('ENUMS.ANNOUNCEMENT_PRIORITY.' + rowData['priority'] | translate)
                    "
                    tooltipPosition="top"
                    tooltipEvent="hover"
                  ></span>
                }
                @case ('title') {
                  <div class="text-ellipsis-2-lines">{{ rowData[col.field] }}</div>
                }
                @case ('workspaceName') {
                  <ng-container
                    [ngTemplateOutlet]="displayNameTemplate"
                    [ngTemplateOutletContext]="{
                      $implicit: rowData,
                      data: {
                        name: rowData.workspaceName,
                        displayName: getDisplayName(rowData.workspaceName, metaData.allWorkspaces),
                        nameAll: 'ANNOUNCEMENT.ALL' | translate,
                        nameNotFound: 'ANNOUNCEMENT.NOT_FOUND' | translate
                      }
                    }"
                  />
                }
                @case ('productName') {
                  <ng-container
                    [ngTemplateOutlet]="displayNameTemplate"
                    [ngTemplateOutletContext]="{
                      $implicit: rowData,
                      data: {
                        name: rowData.productName,
                        displayName: getDisplayName(rowData.productName, metaData.allProducts),
                        nameAll: 'ANNOUNCEMENT.ALL' | translate,
                        nameNotFound: 'ANNOUNCEMENT.NOT_FOUND' | translate
                      }
                    }"
                  />
                }
                @default {
                  <div *ngIf="col.isDate && rowData[col.field]" class="text-ellipsis-2-lines">
                    {{ rowData[col.field] | date: dateFormat }}
                  </div>
                  <ng-container *ngIf="col.isDropdown">
                    {{ 'ENUMS.ANNOUNCEMENT_' + col.header + '.' + rowData[col.field] | translate }}
                  </ng-container>
                }
              }

              <ng-template #displayNameTemplate let-data="data">
                <ng-container *ngIf="!data.name"> {{ data.nameAll }} </ng-container>
                <div
                  *ngIf="data.name"
                  class="text-ellipsis-2-lines"
                  [pTooltip]="data.displayName ? '' : data.name"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                >
                  {{ data.displayName ?? data.nameNotFound }}
                </div>
              </ng-template>
            </td>
          </tr>
        </ng-template>
      </p-table>

      <!-- DELETE -->
      <p-dialog
        [header]="'DIALOG.DETAIL.DELETE.HEADER' | translate"
        [(visible)]="displayDeleteDialog"
        [modal]="true"
        [closable]="true"
        [draggable]="true"
        [resizable]="false"
        [dismissableMask]="true"
        [style]="{ width: '550px' }"
      >
        <div *ngIf="item4Delete" class="flex column-gap-3 justify-content-start align-items-center">
          <div class="pi pi-question-circle text-3xl danger-action-text" aria-hidden="true"></div>
          <section class="w-11 flex flex-column row-gap-3 justify-content-start">
            <div
              id="am_delete_message_text"
              class="mr-3 font-bold"
              [attr.aria-label]="'ACTIONS.CONFIRMATION.QUESTION' | translate"
              role="note"
            >
              {{ 'ACTIONS.DELETE.MESSAGE.TEXT' | translate }}
            </div>
            <div
              id="am_delete_announcement_title"
              class="px-5 text-center danger-action-text text-responsive"
              [attr.aria-label]="'ANNOUNCEMENT.TITLE' | translate"
              role="note"
            >
              {{ item4Delete.title }}
            </div>

            <div class="px-2 flex flex-column row-gap-1 justify-content-center" aria-hidden="true">
              <div *ngIf="item4Delete.status === 'ACTIVE'" class="flex flex-row column-gap-3">
                <div class="w-4 text-right font-bold">{{ 'ANNOUNCEMENT.STATUS' | translate }}</div>
                <div class="w-7 text-left danger-action-text" id="am_delete_active">
                  {{ 'ACTIONS.CONFIRMATION.YES' | translate }}
                </div>
              </div>
              <div class="flex flex-row column-gap-3">
                <div class="w-4 text-right font-bold">{{ 'ANNOUNCEMENT.TYPE' | translate }}</div>
                <div class="w-7 text-left" id="am_delete_type">
                  {{ 'ENUMS.ANNOUNCEMENT_TYPE.' + item4Delete.type | translate }}
                </div>
              </div>
              <div class="flex flex-row column-gap-3">
                <div class="w-4 text-right font-bold">{{ 'ANNOUNCEMENT.WORKSPACE' | translate }}</div>
                <div class="w-7 text-left text-responsive" id="am_delete_workspace">
                  <ng-container *ngIf="item4Delete.workspaceName">
                    {{ getDisplayName(item4Delete.workspaceName, metaData.allWorkspaces) }}
                  </ng-container>
                  <ng-container *ngIf="!item4Delete.workspaceName"> {{ 'ANNOUNCEMENT.ALL' | translate }} </ng-container>
                </div>
              </div>
              <div class="flex flex-row column-gap-3">
                <div class="w-4 text-right font-bold">{{ 'ANNOUNCEMENT.PRODUCT_NAME' | translate }}</div>
                <div class="w-7 text-left text-responsive" id="am_delete_product_name">
                  <ng-container *ngIf="item4Delete.productName">
                    {{ getDisplayName(item4Delete.productName, metaData.allProducts) }}
                  </ng-container>
                  <ng-container *ngIf="!item4Delete.productName"> {{ 'ANNOUNCEMENT.ALL' | translate }} </ng-container>
                </div>
              </div>
            </div>

            <div>{{ 'ACTIONS.DELETE.MESSAGE.INFO' | translate }}</div>
          </section>
        </div>
        <ng-template pTemplate="footer">
          <footer class="flex flex-wrap justify-content-end column-gap-2 row-gap-1">
            <p-button
              id="am_delete_action_no"
              icon="pi pi-times"
              pAutoFocus
              [autofocus]="true"
              (onClick)="displayDeleteDialog = false"
              [label]="'ACTIONS.CONFIRMATION.NO' | translate"
              [ariaLabel]="'ACTIONS.CONFIRMATION.NO.TOOLTIP' | translate"
              [pTooltip]="'ACTIONS.CONFIRMATION.NO.TOOLTIP' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            ></p-button>
            <p-button
              id="am_delete_action_yes"
              icon="pi pi-check"
              (onClick)="onDeleteConfirmation(data)"
              [label]="'ACTIONS.CONFIRMATION.YES' | translate"
              [ariaLabel]="'ACTIONS.CONFIRMATION.YES.TOOLTIP' | translate"
              [pTooltip]="'ACTIONS.CONFIRMATION.YES.TOOLTIP' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            ></p-button>
          </footer>
        </ng-template>
      </p-dialog>
    </ng-container>
  </ocx-page-content>

  <!-- DETAIL -->
  <app-announcement-detail
    [displayDialog]="displayDetailDialog"
    (hideDialogAndChanged)="onCloseDetail($event)"
    [announcement]="item4Detail"
    [allWorkspaces]="metaData.allWorkspaces"
    [allProducts]="metaData.allProducts"
    [changeMode]="changeMode"
  ></app-announcement-detail>
</ocx-portal-page>
